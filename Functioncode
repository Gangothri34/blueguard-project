module.exports = async function (context, req) {
    context.log('HTTP trigger function processed a request.');

    // Check if there is a JSON payload in the request body
    if (req.body) {
        try {
            // The JSON is automatically parsed for you if the Content-Type is 'application/json'
            const payload = req.body;

            context.log('Received JSON payload:');
            context.log(JSON.stringify(payload, null, 2));

            // Check for the SOS alert
            if (payload.SOS === 1) {
                context.log('ðŸš¨ SOS Alert Detected!');
                // Add your custom logic here (e.g., send an email, trigger an alert)
            }

            // Extract sensor data
            const buoyId = payload.id;
            const windSpeed = payload.wind_speed;
            const waterLevel = payload.water_level;
            const humidity = payload.humidity;
            const temperature = payload.temperature;

            // Log the extracted data (corrected template literals)
            context.log(`Buoy ID: ${buoyId}`);
            context.log(`Wind Speed: ${windSpeed}`);
            context.log(`Water Level: ${waterLevel}`);
            context.log(`Humidity: ${humidity}`);
            context.log(`Temperature: ${temperature}`);

            // Respond to the client (the LoRa receiver)
            context.res = {
                status: 200,
                body: "Data received successfully by Azure Function."
            };

        } catch (error) {
            context.log.error('Error parsing JSON payload:', error);
            context.res = {
                status: 400,
                body: "Error: Invalid JSON payload."
            };
        }
    } else {
        context.log('No payload received.');
        context.res = {
            status: 400,
            body: "Error: No data in request body. Please send a JSON payload."
        };
    }
};
